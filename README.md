# Overview

Spring-boot library that will auto-inject support for publishing metrics to the following metrics providers.

* AWS CloudWatch [`DONE`]
* Prometheus [`TODO`]

## Build Status

See [CircleCI > parrot-common-metrics]( https://app.circleci.com/pipelines/bitbucket/arthur/parrot-common-metrics) for build overview.

[![CircleCI](https://dl.circleci.com/status-badge/img/bb/arthur/parrot-common-metrics/tree/master.svg?style=svg&circle-token=851ca61e3da5f561d049f2feb3974b85c12fc2cb)](https://dl.circleci.com/status-badge/redirect/bb/arthur/parrot-common-metrics/tree/master)

## SonarQube

See [SonarQube](http://sonarqube.arthur.com/dashboard?id=parrot-metrics)

# Usage

Any spring-boot application can make use of this library to publish the following types of metrics:

* **Counters** - Measure frequency of occurrence
* **Timers** - Measure duration of operations

1. Include the dependency:

```
    <dependency>
      <groupId>com.arthur</groupId>
      <artifactId>parrot-metrics</artifactId>
      <version>${parrot-metrics.version}</version>
    </dependency>
```

2. Publish metrics:

The library allows metrics to be published in several ways.<br>
a. **Direct Publishing** - Obtain a `Timer` or `Counter` manually from `Metrics` service.

```java
import com.arthur.metrics.meters.MetricsTimer;
import com.arthur.metrics.meters.MetricsTimer.TimerInProgress;
import com.arthur.metrics.service.Metrics;
import java.time.Duration;

public class MyClass {

  @Resource
  private Metrics metricsService;

  private void doSomething() {
    // ... method logic
    Counter counter = metricsService.createOrGetCounter("MyCountMetricName");
    counter.increment();
  }

  private void measureDurationOfOperation_way1() {
    long t0 = System.currentTimeMillis();
    // ... method logic
    MetricsTimer metricsTimer = metricsService.createOrGetTimer("MyMetricName");
    metricsTimer.duration(Duration.ofMillis(System.currentTimeMillis() - t0));
  }

  private void measureDurationOfOperation_way2() {
    // ... method logic
    MetricsTimer metricsTimer = metricsService.createOrGetTimer("MyMetricName");
    TimerInProgress timerInProgress = metricsTimer.start();
    //... do something
    metricsTimer.duration(timerInProgress.stop());
  }

  private void measureDurationOfOperation_way3() {
    // ... method logic
    MetricsTimer metricsTimer = metricsService.createOrGetTimer("MyMetricName");
    TimerInProgress timerInProgress = metricsTimer.start();
    //... do something
    Duration duration = timerInProgress.stop();
    RestApiDimensions restApiDimensions = new RestApiDimensions();
    metricsTimer.duration(duration, restApiDimensions);
  }
}
```

b. **Method Annotations**

Applications can only use the following annotations on Spring managed beans:
<ul>
<li><code>@Count</code> - Count invocations (with option to capture failure scenarios as a separate metric)</li>
<li><code>@Timer</code> - Capture time duration measurements to invoke a method</li>
</ul>

**NOTE**: Recommends to use only either a `@Timer` or `@Count` annotation on a method. `@Timer` implicitly records the total count for an operation.

```java
import com.arthur.metrics.annotations.Count;
import com.arthur.metrics.annotations.Timer;

@Component
public class MySpringManagedClass {

  // capture all invocations to the method
  @Count(name = "MyMetric")
  public void doSomething() {
    //...
  }

  // capture all invocations to the method
  // on failure scenarios, generate `MyCountMetric2.failed` metric
  @Count(name = "MyCountMetric2", captureOnFailure = true)
  public void doSomething() throws RuntimeException {
    //...
  }

  // capture all invocations to the method
  // on failure scenarios, generate `MyCountMetric3-fail` metric
  @Count(name = "MyCountMetric3", failureNameSuffix = "-fail", captureOnFailure = true)
  public void doSomething() throws RuntimeException {
    //...
  }

  // capture time duration to perform the operation/method
  // see "Metric Name Mappings" section below for different metrics generated by platform.
  @Timer(name = "MyTimerMetric")
  public void measureMethodDuration() {
    // ...
  }
}
```

c. **Monitoring restful service api**

Restful applications can register the *Metrics Filter* which captures **timer** metrics information dimensioned by:

- userId
- accountId
- accountName
- httpStatus
- httpMethod
- countryIsoCode
- ipAddress
- requestURI;

**application.yaml**

```yml
 parrot:
   metrics:
     environment: PRODUCTION
     collection-group: DIRECT_API_SERVICE
     metrics-push-frequency-in-seconds: 5
     is-key-based-rest-api-monitoring-enabled: true
```

**NOTE**:

- `is-key-based-rest-api-monitoring-enabled` is switch of restful monitoring. Make it to be **true** enabled all restful monitoring above.
- It works for restful calls with API-KEY from customer outside.

# Tags Captured
The library automatically populate tags (or dimensions in AWS CloudWatch metrics) for both `Counter` and `Timer` metrics.

| Tag                | Value                                               | `@Count` support  | `Count` (via programatically) | `@Timer` support  | `Timer` (via programatically)  |
|--------------------|-----------------------------------------------------|-------------------|-------------------------------|-------------------|--------------------------------|
| `Application Name` | Via configuration                                   | `yes`             | `yes`                         | `yes`             | `yes`                          |
| `Instance Type`    | Via configuration                                   | `yes`             | `yes`                         | `yes`             | `yes`                          |
| `Result`           | `Success` or `Failure` based on operation's success | `yes`             | `yes`                         | `yes`             | `no`                           |
| `Environment`      | `dev`, `local` or `prod` - derived via configuration| `yes`             | `yes`                         | `yes`             | `yes`                          |

* `Instance Type` is optional and only recommended for collectors for the time being.

# Metric Name Mappings

The table below shows how the metric names are mapped to different systems:

## AWS

| Metric Type | Example Metric Name | AWS CloudWatch Metric Name(s) | Description of Metric                                                    |
|-------------|---------------------|-------------------------------|--------------------------------------------------------------------------|
| **Counter** | `my.counterMetric`  | `my.counterMetric.count`      | Captures counts of invocations                                           |
| **Timer**   | `my.timerMetric`    | `my.timerMetric.count`        | Captures counts of invocations                                           |
| **Timer**   | `my.timerMetric`    | `my.timerMetric.sum`          | Captures value of durations (in millis)                                  |
| **Timer**   | `my.timerMetric`    | `my.timerMetric.avg`          | Captures average value (in millis) of all captured metric values         |
| **Timer**   | `my.timerMetric`    | `my.timerMetric.max`          | Captures the maximum value (in millis) out of all captured metric values |

# Configuration

| Configuration Name                                 | Type    | Is Mandatory | Default Value | Description                                                                                                                                                          |
|----------------------------------------------------|---------|--------------|---------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `spring.application.name`                          | String  | Yes          | N/A           | Name of the application that publishes metrics. Used as the the `Application Name` tag.                                                                              |
| `parrot.metrics.collection-group`                  | String  | Yes          | N/A           | High level group, which the metrics belongs to. Used as the metrics namespace. See <code>com.arthur.metrics.config.CollectionGroup</code> for valid values. |
| `parrot.metrics.app-name`                          | String  | No           | Empty         | Ability to override the `Application Name` tag to support existing applications that publish metrics via legacy library.                                             |
| `parrot.metrics.metrics-push-frequency-in-seconds` | Integer | No           | `30`          | How often metrics data are published (asynchronously)                                                                                                                |
| `parrot.metrics.could-watch-config.aws-region`     | String  | No           | `us-east-1`   | Default AWS region when publishing CloudWatch metrics                                                                                                                |
| `parrot.metrics.environment`                       | String  | No           | `DEVELOPMENT` | Environment where the application is being deployed. Can be either <ul><li>`PRODUCTION` - for production</li><li>`DEVELOPMENT` - for deployments to dev</li><li>`LOCAL` - for local development</li></ul>           |

# Future Improvements
* Add support for monitoring user initiated (i.e. non key-based) REST APIs

# References

* [Micrometer Documentation](https://micrometer.io/docs)
* [AWS CloudWatch](https://aws.amazon.com/cloudwatch/)
* [Prometheus](https://prometheus.io/)